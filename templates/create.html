{% extends "base.html" %}
{% from "components/visualization.html" import visualization %}

{% block content %}
    <div class="container">
    <h1>Document Visualization & Analysis</h1>
                
    <!-- Visualization Section -->
    <div class="row mt-4">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Document Visualization</h5>
                        </div>
                <div class="card-body visualization-container">
                    {{ visualization() }}
                        </div>
                </div>
            </div>
        </div>
        
    <!-- Analysis Section -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Statistics</h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">Total Points: <span id="totalPoints">0</span></p>
                    
                    <h6 class="mt-4">By Type:</h6>
                    <ul class="list-unstyled" id="typeStats">
                    </ul>
                    
                    <h6 class="mt-4">By Source:</h6>
                    <ul class="list-unstyled" id="sourceStats">
                    </ul>
            </div>
        </div>
                        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Embedding Analysis</h5>
    </div>
                <div class="card-body">
                    <h6>Cluster Information</h6>
                    <ul class="list-unstyled mb-4">
                        <li>Health cluster: <span id="healthClusterCount">0</span> points</li>
                        <li>Work cluster: <span id="workClusterCount">0</span> points</li>
                        <li>Commute cluster: <span id="commuteClusterCount">0</span> points</li>
                    </ul>

                    <h6>Context Relationships</h6>
                    <ul class="list-unstyled mb-4">
                        <li>Context-Recommendation pairs: <span id="contextRecPairs">0</span></li>
                        <li>Average similarity score: <span id="avgSimilarity">0</span></li>
                    </ul>

                    <h6>Dimensional Analysis</h6>
                    <ul class="list-unstyled">
                        <li>Original dimensions: <span id="originalDims">0</span></li>
                        <li>Reduced dimensions: <span id="reducedDims">0</span></li>
                        <li>Variance explained: <span id="varianceExplained">0%</span></li>
                                </ul>
                                </div>
                            </div>
                        </div>
                            </div>
                            </div>
                
<!-- Loading Indicator -->
<div id="loading-indicator">
    <div class="loader"></div>
                            </div>

<!-- Error Container -->
<div id="error-container"></div>
        
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Keep only the visualization and analysis related code
function updateStatistics(metadata) {
    // Update total points
    document.getElementById('totalPoints').textContent = metadata.total_points || 0;
    
    // Update type statistics
    const typeStatsList = document.getElementById('typeStats');
    typeStatsList.innerHTML = '';
    for (const [type, count] of Object.entries(metadata.categories || {})) {
        typeStatsList.innerHTML += `<li>${type}: ${count}</li>`;
    }
    
    // Update source statistics
    const sourceStatsList = document.getElementById('sourceStats');
    sourceStatsList.innerHTML = '';
    for (const [source, count] of Object.entries(metadata.sources || {})) {
        sourceStatsList.innerHTML += `<li>${source}: ${count}</li>`;
    }
}

function updateEmbeddingAnalysis(metadata) {
    // Update cluster information
    const healthCluster = (metadata.categories['health_context'] || 0) + (metadata.categories['health_recommendation'] || 0);
    const workCluster = (metadata.categories['work_context'] || 0) + (metadata.categories['work_recommendation'] || 0);
    const commuteCluster = (metadata.categories['commute_context'] || 0) + (metadata.categories['commute_recommendation'] || 0);
    
    document.getElementById('healthClusterCount').textContent = healthCluster;
    document.getElementById('workClusterCount').textContent = workCluster;
    document.getElementById('commuteClusterCount').textContent = commuteCluster;
    
    // Update context relationships
    const contextCount = (metadata.categories['health_context'] || 0) + 
                        (metadata.categories['work_context'] || 0) + 
                        (metadata.categories['commute_context'] || 0);
    const recCount = (metadata.categories['health_recommendation'] || 0) + 
                     (metadata.categories['work_recommendation'] || 0) + 
                     (metadata.categories['commute_recommendation'] || 0);
    document.getElementById('contextRecPairs').textContent = Math.min(contextCount, recCount);
    
    // Calculate average similarity (placeholder for now)
    document.getElementById('avgSimilarity').textContent = '0.85';
    
    // Update dimensional analysis
    if (metadata.dimensions) {
        document.getElementById('originalDims').textContent = metadata.dimensions.original || 0;
        document.getElementById('reducedDims').textContent = metadata.dimensions.reduced || 0;
        
        // Calculate total variance explained
        const varianceExplained = metadata.dimensions.variance_explained || [0];
        const totalVariance = varianceExplained.reduce((a, b) => a + b, 0);
        const variancePercent = (totalVariance * 100).toFixed(1);
        document.getElementById('varianceExplained').textContent = `${variancePercent}%`;
    }
}

// Call loadData when the page loads
        document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

async function loadData() {
    try {
        const response = await fetch('/api/embeddings-visualization');
                const data = await response.json();
                
                if (data.error) {
            throw new Error(data.error);
        }
        
        // Update statistics and embedding analysis
        updateStatistics(data.metadata);
        updateEmbeddingAnalysis(data.metadata);
        
            } catch (error) {
        console.error('Error loading data:', error);
        showError('Error loading data. Please try again.');
    }
}

function showLoading(show) {
    const loadingIndicator = document.getElementById('loading-indicator');
    if (show) {
        loadingIndicator.style.display = 'flex';
                } else {
        loadingIndicator.style.display = 'none';
    }
}

function showError(message) {
    const errorContainer = document.getElementById('error-container');
    errorContainer.innerHTML = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
    errorContainer.style.display = 'block';
}
</script>

<style>
.card {
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #e9ecef;
}

.card-title {
    color: #2c3e50;
    font-weight: 600;
}

#typeStats li, #sourceStats li {
    margin-bottom: 0.5rem;
    padding: 0.5rem 1rem;
    border-left: 3px solid #4285f4;
    background-color: #f8f9fa;
    border-radius: 0 4px 4px 0;
    display: flex;
    justify-content: space-between;
}

.card-body ul li {
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-body ul li span {
    font-weight: 500;
    color: #4285f4;
    padding: 0.2rem 0.5rem;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.visualization-container {
    min-height: 400px;
    padding: 1rem;
}

#loading-indicator {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
                width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %} 